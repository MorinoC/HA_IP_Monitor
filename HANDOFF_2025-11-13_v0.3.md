# ğŸ¤ é¡¹ç›®äº¤æ¥æ–‡ä»¶ - 2025-11-13

> **ç‰ˆæœ¬**: v0.3.0-dev
> **äº¤æ¥æ—¶é—´**: 2025-11-13 19:00
> **é¡¹ç›®é˜¶æ®µ**: Phase 3 - VPS APIä¸šåŠ¡é€»è¾‘å®ç° âœ…
> **ä¸‹æ¬¡æ¥æ‰‹**: 2025-11-14 (æ˜å¤©)

---

## ğŸ“‹ ä»Šæ—¥å®Œæˆå·¥ä½œ

### âœ… ä¸»è¦æˆæœ

#### 1. **VPS APIä¸šåŠ¡é€»è¾‘å®ç°** (`remote_scripts/vps_monitor_api.py`) â­â­â­

**æ ¸å¿ƒåŠŸèƒ½å®ç°**:

##### ç³»ç»ŸçŠ¶æ€ç›‘æ§ (`get_system_stats`)
- CPUä½¿ç”¨ç‡æ£€æµ‹ - é€šè¿‡`top -bn1`å‘½ä»¤è§£æ
- å†…å­˜ä½¿ç”¨ç‡ç»Ÿè®¡ - é€šè¿‡`free -m`å‘½ä»¤
- ç³»ç»Ÿè¿è¡Œæ—¶é—´ - é€šè¿‡`uptime -p`å‘½ä»¤
- ç£ç›˜ä½¿ç”¨æƒ…å†µ - é€šè¿‡`df -h /`å‘½ä»¤
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé»˜è®¤å€¼

**ä»£ç ç¤ºä¾‹**:
```python
def get_system_stats():
    # CPU: è§£æ top è¾“å‡ºè·å– idle%ï¼Œè®¡ç®— usage% = 100 - idle
    # Memory: è§£æ free è¾“å‡ºè®¡ç®—ä½¿ç”¨ç‡
    # Uptime: è·å–ç³»ç»Ÿè¿è¡Œæ—¶é—´
    # Disk: è·å–æ ¹åˆ†åŒºä½¿ç”¨æƒ…å†µ
    return {
        'cpu_usage': 25.5,
        'memory_usage': 48.2,
        'uptime': '15 days, 3:24:10',
        'disk_usage': '45%'
    }
```

##### æ—¥å¿—è§£æå¼•æ“ (`parse_auth_log`)
- è§£æ `/var/log/auth.log` è·å–æ”»å‡»æ—¥å¿—
- **SSHæ”»å‡»æ£€æµ‹**: æ­£åˆ™åŒ¹é… `Failed password for ... from <IP>`
- **VPNæ”»å‡»æ£€æµ‹**: æ­£åˆ™åŒ¹é… `wireguard|openvpn ... failed ... <IP>`
- ç»Ÿè®¡ä»Šæ—¥æ”»å‡»æ¬¡æ•°å’Œå”¯ä¸€æ”»å‡»è€…æ•°é‡
- æŒ‰æ”»å‡»æ¬¡æ•°æ’åºï¼Œè¿”å›å‰50åæ”»å‡»IP

**æ­£åˆ™è¡¨è¾¾å¼**:
```python
# SSHå¤±è´¥ç™»å½•
ssh_pattern = r'Failed password for (?:invalid user )?(\w+) from ([\d\.]+) port (\d+)'

# VPNè¿æ¥å¤±è´¥
vpn_pattern = r'(wireguard|openvpn).*(failed|invalid|rejected).*([\d\.]+)'
```

**è¿”å›æ•°æ®**:
```python
{
    'ssh_attacks_today': 234,
    'vpn_attacks_today': 45,
    'attack_ips': [
        {
            'ip_address': '185.200.116.43',
            'ssh_attempts': 156,
            'vpn_attempts': 0,
            'total_attempts': 156
        },
        # ... æ›´å¤šIP
    ],
    'unique_attackers': 42
}
```

##### UFWé˜²ç«å¢™é›†æˆ (`get_ufw_status`, `block_ip`, `unblock_ip`)
- **è·å–çŠ¶æ€**: è§£æ`sudo ufw status numbered`è¾“å‡º
- **å°ç¦IP**: æ‰§è¡Œ`sudo ufw deny from <IP>`
- **è§£å°IP**: æ‰§è¡Œ`sudo ufw delete deny from <IP>`
- IPæ ¼å¼éªŒè¯é˜²æ­¢å‘½ä»¤æ³¨å…¥
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**UFWå‘½ä»¤å°è£…**:
```python
def block_ip():
    # éªŒè¯IPæ ¼å¼
    if not re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', ip_address):
        return error

    # æ‰§è¡ŒUFWå‘½ä»¤
    stdout, stderr, returncode = run_command(
        ['sudo', 'ufw', 'deny', 'from', ip_address]
    )

    # è¿”å›ç»“æœ
    return {'success': True, 'ip_address': ip, 'blocked_at': timestamp}
```

##### å¨èƒåˆ†æ (`calculate_threat_level`, `get_threats`)
- **å¨èƒç­‰çº§è®¡ç®—**:
  - `< 10 æ”»å‡»`: low
  - `< 50 æ”»å‡»`: medium
  - `< 200 æ”»å‡»`: high
  - `>= 200 æ”»å‡»`: critical
- æ„å»ºå®Œæ•´å¨èƒIPåˆ—è¡¨
- æ ‡è®°æ¯ä¸ªIPçš„å°ç¦çŠ¶æ€
- ç»Ÿè®¡æ•´ä½“å¨èƒç­‰çº§

**æ•°æ®ç»“æ„**:
```python
{
    'threat_level': 'high',
    'total_threats': 42,
    'total_attacks': 279,
    'threat_list': [
        {
            'ip_address': '185.200.116.43',
            'country': 'Unknown',  # TODO: GeoIP
            'attack_count': 156,
            'threat_level': 'critical',
            'blocked': True
        },
        # ...
    ]
}
```

##### ç™½åå•ç®¡ç† (`manage_whitelist`)
- **GET**: è¯»å–`/etc/ha_monitor/whitelist.conf`
- **POST**: è¿½åŠ IPåˆ°ç™½åå•æ–‡ä»¶
- **DELETE**: ä»æ–‡ä»¶åˆ é™¤æŒ‡å®šIP
- æ–‡ä»¶æŒä¹…åŒ–å­˜å‚¨
- è‡ªåŠ¨åˆ›å»ºé…ç½®ç›®å½•

##### IPè¯¦ç»†ä¿¡æ¯ (`get_ip_info`)
- æŸ¥è¯¢æŒ‡å®šIPçš„å®Œæ•´æ”»å‡»è®°å½•
- è®¡ç®—å¨èƒè¯„åˆ†ï¼ˆ0-10åˆ†åˆ¶ï¼‰
- æ˜¾ç¤ºSSH/VPNæ”»å‡»åˆ†å¸ƒ
- æ˜¾ç¤ºå°ç¦çŠ¶æ€å’Œæ—¶é—´ä¿¡æ¯

##### ç´§æ€¥é”å®š (`emergency_lockdown`)
- åˆ›å»ºç´§æ€¥æ¨¡å¼æ ‡è®°æ–‡ä»¶ `/tmp/ha_monitor_emergency.lock`
- è®°å½•é”å®šæ—¶é—´å’ŒåŸå› 
- é¢„ç•™æ‰©å±•æ¥å£ï¼ˆæœªæ¥å¯æ·»åŠ å®é™…é”å®šé€»è¾‘ï¼‰
- è¿”å›æ‰§è¡Œçš„å®‰å…¨æªæ–½åˆ—è¡¨

**æŠ€æœ¯ç‰¹æ€§**:

1. **30ç§’ç¼“å­˜æœºåˆ¶**
   ```python
   _cache = {
       'last_update': None,
       'stats': None
   }
   CACHE_DURATION = 30  # ç§’
   ```
   - å‡å°‘æ—¥å¿—è§£æå¼€é”€
   - é¿å…é‡å¤æ–‡ä»¶è¯»å–
   - æé«˜APIå“åº”é€Ÿåº¦

2. **å®Œæ•´é”™è¯¯å¤„ç†**
   - æ‰€æœ‰å‡½æ•°éƒ½æœ‰try-exceptåŒ…è£¹
   - è¶…æ—¶ä¿æŠ¤ï¼ˆ30ç§’ï¼‰
   - é»˜è®¤å€¼è¿”å›æœºåˆ¶
   - è¯¦ç»†é”™è¯¯æ—¥å¿—

3. **å®‰å…¨ç‰¹æ€§**
   - Bearer Tokenè®¤è¯
   - IPæ ¼å¼æ­£åˆ™éªŒè¯
   - å‘½ä»¤æ³¨å…¥é˜²æŠ¤
   - æƒé™æ£€æŸ¥

4. **è·¨å¹³å°æ”¯æŒ**
   ```python
   # Windowså¼€å‘ç¯å¢ƒUTF-8æ”¯æŒ
   if sys.platform == 'win32':
       sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
   ```

**APIç«¯ç‚¹æ€»è§ˆ**:

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½ | è®¤è¯ | çŠ¶æ€ |
|------|------|------|------|------|
| GET | /health | å¥åº·æ£€æŸ¥ | âŒ | âœ… |
| GET | /api/status | ç³»ç»ŸçŠ¶æ€ | âœ… | âœ… |
| GET | /api/threats | å¨èƒåˆ—è¡¨ | âœ… | âœ… |
| POST | /api/block | å°ç¦IP | âœ… | âœ… |
| POST | /api/unblock | è§£å°IP | âœ… | âœ… |
| GET/POST/DELETE | /api/whitelist | ç™½åå•ç®¡ç† | âœ… | âœ… |
| POST | /api/ip_info | IPè¯¦æƒ… | âœ… | âœ… |
| POST | /api/emergency | ç´§æ€¥é”å®š | âœ… | âœ… |

#### 2. **Mock APIæœåŠ¡å™¨ä¼˜åŒ–** (`dev_tools/mock_vps_api.py`)
- æ·»åŠ UTF-8ç¼–ç æ”¯æŒï¼ˆWindowsç¯å¢ƒï¼‰
- ä¿®å¤Unicodeè¾“å‡ºé”™è¯¯
- ç¡®ä¿emojiæ­£å¸¸æ˜¾ç¤º

### ğŸ“Š å·¥ä½œé‡ç»Ÿè®¡
- **æ–‡ä»¶ä¿®æ”¹**: 2ä¸ªä¸»è¦æ–‡ä»¶
  - `remote_scripts/vps_monitor_api.py`: 192è¡Œ â†’ 729è¡Œ (+537è¡Œ)
  - `dev_tools/mock_vps_api.py`: 299è¡Œ â†’ 310è¡Œ (+11è¡Œ)
- **æ–°å¢åŠŸèƒ½**: 8ä¸ªAPIç«¯ç‚¹ï¼Œ7ä¸ªæ ¸å¿ƒå‡½æ•°
- **ä»£ç è¡Œæ•°**: ~550è¡Œæ–°å¢ç”Ÿäº§ä»£ç 
- **å·¥ä½œæ—¶é•¿**: ~2å°æ—¶
- **å®Œæˆåº¦**: Phase 3 VPS APIä¸šåŠ¡é€»è¾‘ 100%

---

## ğŸ” å½“å‰é¡¹ç›®çŠ¶æ€

### å®Œæ•´æ–‡ä»¶ç»“æ„
```
HA_IP_Monitor/
â”œâ”€â”€ custom_components/ha_ip_monitor/
â”‚   â”œâ”€â”€ __init__.py                âœ… é›†æˆå…¥å£ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ manifest.json              âœ… ä¾èµ–é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ const.py                   âœ… å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ config_flow.py             âœ… é…ç½®æµç¨‹
â”‚   â”œâ”€â”€ coordinator.py             âœ… æ•°æ®åè°ƒå™¨ï¼ˆPhase 2å®Œæˆï¼‰
â”‚   â”œâ”€â”€ sensor.py                  âœ… ä¼ æ„Ÿå™¨å®ä½“ï¼ˆPhase 2å®Œæˆï¼‰
â”‚   â””â”€â”€ translations/
â”‚       â”œâ”€â”€ en.json                âœ… è‹±æ–‡ç¿»è¯‘
â”‚       â”œâ”€â”€ zh-Hans.json           âœ… ä¸­æ–‡ç¿»è¯‘
â”‚       â””â”€â”€ ja.json                âœ… æ—¥è¯­ç¿»è¯‘
â”œâ”€â”€ remote_scripts/
â”‚   â”œâ”€â”€ vps_monitor_api.py         âœ… VPS APIæœåŠ¡å™¨ï¼ˆPhase 3å®Œæˆï¼‰â­
â”‚   â”œâ”€â”€ installer.sh               âœ… å®‰è£…è„šæœ¬
â”‚   â”œâ”€â”€ requirements.txt           âœ… Pythonä¾èµ–
â”‚   â”œâ”€â”€ config_template.yaml       âœ… é…ç½®æ¨¡æ¿
â”‚   â””â”€â”€ README.md                  âœ… éƒ¨ç½²æ–‡æ¡£
â”œâ”€â”€ dev_tools/
â”‚   â””â”€â”€ mock_vps_api.py            âœ… Mock APIæœåŠ¡å™¨ï¼ˆå·²ä¼˜åŒ–ï¼‰
â”œâ”€â”€ tests/                         âœ… æµ‹è¯•ç›®å½•
â”œâ”€â”€ www/ha-ip-monitor-card/        âœ… å‰ç«¯å¡ç‰‡
â”œâ”€â”€ docs/                          âœ… æ–‡æ¡£ç›®å½•
â”œâ”€â”€ README.md                      âœ… é¡¹ç›®è¯´æ˜
â””â”€â”€ HANDOFF_2025-11-13_v0.3.md    âœ… æœ¬æ–‡ä»¶
```

### å¼€å‘è¿›åº¦

#### âœ… Phase 1: åŸºç¡€æ¶æ„ (100%)
- é¡¹ç›®ç»“æ„æ­å»º
- é…ç½®æµç¨‹å®ç°
- å¸¸é‡å®šä¹‰
- å¤šè¯­è¨€æ”¯æŒ

#### âœ… Phase 2: æ•°æ®å±‚ (100%)
- æ•°æ®åè°ƒå™¨å®ç°
- 5ä¸ªä¼ æ„Ÿå™¨å®ä½“
- APIé€šä¿¡æœºåˆ¶
- é”™è¯¯å¤„ç†

#### âœ… Phase 3: VPS APIä¸šåŠ¡é€»è¾‘ (100%)
- ç³»ç»ŸçŠ¶æ€ç›‘æ§ âœ…
- auth.logæ—¥å¿—è§£æ âœ…
- UFWé˜²ç«å¢™é›†æˆ âœ…
- å¨èƒåˆ†æå¼•æ“ âœ…
- ç™½åå•ç®¡ç† âœ…
- ç´§æ€¥é”å®šåŠŸèƒ½ âœ…
- IPè¯¦ç»†ä¿¡æ¯æŸ¥è¯¢ âœ…

#### â³ Phase 4: æœåŠ¡åŠŸèƒ½ (å¾…å¼€å§‹)
- HAæœåŠ¡å®šä¹‰ (`services.yaml`)
- æœåŠ¡æ³¨å†Œå’Œè°ƒç”¨
- æœåŠ¡å›½é™…åŒ–

#### â³ Phase 5: é›†æˆæµ‹è¯• (å¾…å¼€å§‹)
- VPSéƒ¨ç½²æµ‹è¯•
- HAé›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯æµ‹è¯•

---

## ğŸ¯ ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’

### é«˜ä¼˜å…ˆçº§ä»»åŠ¡

#### 1. å®ç°Home AssistantæœåŠ¡åŠŸèƒ½ â­
**æ–‡ä»¶**: `custom_components/ha_ip_monitor/services.yaml`

**éœ€è¦å®šä¹‰çš„æœåŠ¡**:
```yaml
block_ip:
  description: "å°é”æŒ‡å®šIPåœ°å€"
  fields:
    ip_address:
      description: "è¦å°é”çš„IPåœ°å€"
      example: "192.168.1.100"
      required: true
    duration:
      description: "å°é”æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰"
      example: 60

unblock_ip:
  description: "è§£é™¤IPå°é”"
  fields:
    ip_address:
      description: "è¦è§£å°çš„IPåœ°å€"
      example: "192.168.1.100"
      required: true

emergency_lockdown:
  description: "ç´§æ€¥å®‰å…¨é”å®š"
  fields:
    reason:
      description: "é”å®šåŸå› ï¼ˆå¯é€‰ï¼‰"
      example: "æ£€æµ‹åˆ°å¤§è§„æ¨¡æ”»å‡»"
```

**åœ¨ `__init__.py` ä¸­æ³¨å†ŒæœåŠ¡**:
```python
async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:
    # ... ç°æœ‰ä»£ç  ...

    # æ³¨å†ŒæœåŠ¡
    async def handle_block_ip(call):
        """å¤„ç†å°é”IPæœåŠ¡è°ƒç”¨"""
        ip_address = call.data.get("ip_address")
        coordinator = hass.data[DOMAIN][entry.entry_id]
        await coordinator.async_block_ip(ip_address)

    hass.services.async_register(DOMAIN, "block_ip", handle_block_ip)
    # ... å…¶ä»–æœåŠ¡ ...
```

#### 2. VPSéƒ¨ç½²å’Œæµ‹è¯•
**ç›®æ ‡**: åœ¨çœŸå®VPSä¸Šéƒ¨ç½²APIæœåŠ¡å™¨

**æ­¥éª¤**:
1. ä¸Šä¼  `remote_scripts/` åˆ°VPS
2. è¿è¡Œ `installer.sh` å®‰è£…è„šæœ¬
3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆAPI_TOKEN, API_PORTï¼‰
4. å¯åŠ¨æœåŠ¡: `python3 vps_monitor_api.py`
5. æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
6. é…ç½®systemdæœåŠ¡è‡ªåŠ¨å¯åŠ¨

**æµ‹è¯•æ¸…å•**:
- [ ] å¥åº·æ£€æŸ¥: `curl http://localhost:5001/health`
- [ ] ç³»ç»ŸçŠ¶æ€: `curl -H "Authorization: Bearer <token>" http://localhost:5001/api/status`
- [ ] å¨èƒåˆ—è¡¨: `curl -H "Authorization: Bearer <token>" http://localhost:5001/api/threats`
- [ ] å°ç¦IP: æµ‹è¯•UFWå‘½ä»¤æ‰§è¡Œ
- [ ] æ—¥å¿—è§£æ: æ£€æŸ¥auth.logè§£ææ˜¯å¦æ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•: ç¼“å­˜æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ

#### 3. Home Assistanté›†æˆæµ‹è¯•
**ç›®æ ‡**: åœ¨HAä¸­å®Œæ•´æµ‹è¯•é›†æˆ

**æ­¥éª¤**:
1. å¤åˆ¶é›†æˆåˆ°HAçš„`custom_components/`
2. é‡å¯Home Assistant
3. é€šè¿‡UIæ·»åŠ é›†æˆ
4. é…ç½®VPSè¿æ¥ä¿¡æ¯ï¼ˆä½¿ç”¨WireGuardéš§é“IPï¼‰
5. éªŒè¯5ä¸ªä¼ æ„Ÿå™¨æ˜¯å¦åˆ›å»º
6. éªŒè¯æ•°æ®æ˜¯å¦æ­£å¸¸æ›´æ–°ï¼ˆ60ç§’é—´éš”ï¼‰
7. æµ‹è¯•æœåŠ¡è°ƒç”¨ï¼ˆblock_ip, unblock_ipï¼‰
8. æ£€æŸ¥HAæ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

**æµ‹è¯•æ¸…å•**:
- [ ] é›†æˆèƒ½å¦æ­£å¸¸åŠ è½½
- [ ] é…ç½®å‘å¯¼èƒ½å¦æ­£å¸¸æ˜¾ç¤º
- [ ] 5ä¸ªä¼ æ„Ÿå™¨èƒ½å¦æ­£å¸¸åˆ›å»º
- [ ] ä¼ æ„Ÿå™¨æ•°æ®èƒ½å¦æ­£å¸¸æ›´æ–°
- [ ] æœåŠ¡è°ƒç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦æ­£å¸¸
- [ ] æ—¥å¿—è¾“å‡ºæ˜¯å¦æ¸…æ™°

### ä¸­ä¼˜å…ˆçº§ä»»åŠ¡

#### 4. ä¼˜åŒ–å’Œå¢å¼ºåŠŸèƒ½
- **GeoIPé›†æˆ**: æ·»åŠ IPåœ°ç†ä½ç½®æŸ¥è¯¢ï¼ˆä½¿ç”¨MaxMind GeoLite2ï¼‰
- **24å°æ—¶æ”»å‡»è¶‹åŠ¿**: å®ç°æ¯å°æ—¶æ”»å‡»ç»Ÿè®¡
- **è‡ªåŠ¨å°ç¦é˜ˆå€¼**: æ”»å‡»æ¬¡æ•°è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨å°ç¦
- **é€šçŸ¥åŠŸèƒ½**: é›†æˆHAé€šçŸ¥æœåŠ¡
- **å‰ç«¯å¡ç‰‡**: åˆ›å»ºè‡ªå®šä¹‰Lovelaceå¡ç‰‡

#### 5. æ–‡æ¡£å®Œå–„
- æ›´æ–°READMEæ·»åŠ å®Œæ•´ä½¿ç”¨è¯´æ˜
- åˆ›å»ºå®‰è£…éƒ¨ç½²æ•™ç¨‹ï¼ˆå¸¦æˆªå›¾ï¼‰
- æ·»åŠ æ•…éšœæ’æŸ¥æŒ‡å—
- åˆ›å»ºAPIæ–‡æ¡£

### ä½ä¼˜å…ˆçº§ä»»åŠ¡

#### 6. ä»£ç ä¼˜åŒ–
- æ·»åŠ ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰
- ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½
- æ·»åŠ å•å…ƒæµ‹è¯•
- ä»£ç é£æ ¼æ£€æŸ¥ï¼ˆPEP8ï¼‰

---

## ğŸ“ é‡è¦æŠ€æœ¯è¯´æ˜

### VPS APIè¿è¡Œç¯å¢ƒè¦æ±‚

**ç³»ç»Ÿè¦æ±‚**:
- Ubuntu 24.04 LTSï¼ˆæˆ–å…¶ä»–Linuxå‘è¡Œç‰ˆï¼‰
- Python 3.9+
- UFWé˜²ç«å¢™å·²å¯ç”¨
- sudoæƒé™ï¼ˆæ‰§è¡ŒUFWå‘½ä»¤ï¼‰

**æ–‡ä»¶æƒé™**:
- `/var/log/auth.log` - éœ€è¦è¯»å–æƒé™
- `/etc/ha_monitor/` - éœ€è¦åˆ›å»ºç›®å½•å’Œæ–‡ä»¶æƒé™
- `/var/log/ha_monitor_api.log` - éœ€è¦å†™å…¥æƒé™

**ç½‘ç»œé…ç½®**:
- APIç«¯å£5001éœ€è¦åœ¨WireGuardéš§é“å†…å¯è®¿é—®
- é˜²ç«å¢™å…è®¸ä»HAçš„WireGuard IPè®¿é—®

### æ­£åˆ™è¡¨è¾¾å¼è¯´æ˜

**SSHæ”»å‡»æ¨¡å¼**:
```python
r'Failed password for (?:invalid user )?(\w+) from ([\d\.]+) port (\d+)'
```
- åŒ¹é…: `Failed password for admin from 192.168.1.1 port 12345`
- åŒ¹é…: `Failed password for invalid user test from 1.2.3.4 port 22`
- æ•è·ç»„: (1)ç”¨æˆ·å (2)IPåœ°å€ (3)ç«¯å£

**VPNæ”»å‡»æ¨¡å¼**:
```python
r'(wireguard|openvpn).*(failed|invalid|rejected).*([\d\.]+)'
```
- åŒ¹é…: `wireguard handshake failed from 192.168.1.1`
- åŒ¹é…: `openvpn connection rejected 1.2.3.4`
- æ•è·ç»„: (1)VPNç±»å‹ (2)å¤±è´¥åŸå›  (3)IPåœ°å€

### ç¼“å­˜æœºåˆ¶

```python
# å…¨å±€ç¼“å­˜å˜é‡
_cache = {
    'last_update': None,
    'stats': None
}
CACHE_DURATION = 30  # ç§’

# ä½¿ç”¨ç¤ºä¾‹
now = datetime.now()
if (_cache['last_update'] is None or
    (now - _cache['last_update']).total_seconds() > CACHE_DURATION):
    _cache['stats'] = parse_auth_log()
    _cache['last_update'] = now
```

**ä¼˜åŠ¿**:
- å‡å°‘æ–‡ä»¶I/Oæ“ä½œ
- æé«˜APIå“åº”é€Ÿåº¦
- é™ä½CPUä½¿ç”¨ç‡

**æ³¨æ„**:
- æ•°æ®æœ€å¤šå»¶è¿Ÿ30ç§’
- é‡å¯æœåŠ¡åç¼“å­˜æ¸…ç©º

---

## âš ï¸ å·²çŸ¥é—®é¢˜å’Œé™åˆ¶

### å½“å‰é™åˆ¶

1. **GeoIPåŠŸèƒ½æœªå®ç°**
   - æ‰€æœ‰IPçš„countryæ˜¾ç¤ºä¸º"Unknown"
   - éœ€è¦é›†æˆMaxMind GeoLite2æ•°æ®åº“

2. **24å°æ—¶è¶‹åŠ¿æœªå®ç°**
   - `attack_trend`æ•°ç»„å½“å‰ä¸ºç©º
   - éœ€è¦å®ç°æ¯å°æ—¶ç»Ÿè®¡å­˜å‚¨

3. **ç´§æ€¥é”å®šæœªå®Œå…¨å®ç°**
   - åªåˆ›å»ºæ ‡è®°æ–‡ä»¶
   - æœªå®é™…æ‰§è¡Œé˜²ç«å¢™é”å®š
   - æœªå‘é€é€šçŸ¥

4. **åˆæ¬¡æ£€æµ‹æ—¶é—´ä¸å‡†ç¡®**
   - IPçš„`first_seen`æ˜¾ç¤ºå½“å‰æ—¶é—´
   - éœ€è¦å®ç°å†å²è®°å½•å­˜å‚¨

### æ€§èƒ½è€ƒè™‘

- `parse_auth_log()` åœ¨å¤§æ—¥å¿—æ–‡ä»¶æ—¶å¯èƒ½è¾ƒæ…¢
- å»ºè®®å®šæœŸè½®è½¬auth.log
- 30ç§’ç¼“å­˜å¯èƒ½åœ¨é«˜é¢‘æ”»å‡»æ—¶æ•°æ®ä¸å¤Ÿå®æ—¶

### å®‰å…¨æ³¨æ„äº‹é¡¹

- API Tokenåº”ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
- å»ºè®®ä½¿ç”¨HTTPSï¼ˆé…ç½®åå‘ä»£ç†ï¼‰
- UFWå‘½ä»¤éœ€è¦sudoæƒé™
- å»ºè®®ä½¿ç”¨ä¸“ç”¨érootç”¨æˆ·è¿è¡ŒAPIæœåŠ¡å™¨

---

## ğŸ”§ è°ƒè¯•å»ºè®®

### VPS APIè°ƒè¯•

**æŸ¥çœ‹æ—¥å¿—**:
```bash
# å®æ—¶æŸ¥çœ‹APIæ—¥å¿—
tail -f /var/log/ha_monitor_api.log

# æŸ¥çœ‹auth.log
sudo tail -f /var/log/auth.log

# æŸ¥çœ‹UFWè§„åˆ™
sudo ufw status numbered
```

**æ‰‹åŠ¨æµ‹è¯•API**:
```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export API_TOKEN="your-secure-token"
export API_PORT=5001

# å¯åŠ¨æœåŠ¡ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
python3 vps_monitor_api.py

# å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl http://localhost:5001/health
curl -H "Authorization: Bearer your-secure-token" http://localhost:5001/api/status
```

**æµ‹è¯•æ—¥å¿—è§£æ**:
```python
# åˆ›å»ºæµ‹è¯•è„šæœ¬
from vps_monitor_api import parse_auth_log
result = parse_auth_log()
print(f"SSHæ”»å‡»: {result['ssh_attacks_today']}")
print(f"VPNæ”»å‡»: {result['vpn_attacks_today']}")
print(f"æ”»å‡»IPæ•°: {len(result['attack_ips'])}")
```

### Home Assistantè°ƒè¯•

**æŸ¥çœ‹HAæ—¥å¿—**:
```bash
# æŸ¥çœ‹é›†æˆæ—¥å¿—
grep ha_ip_monitor /config/home-assistant.log

# æˆ–åœ¨HA UIä¸­: è®¾ç½® â†’ ç³»ç»Ÿ â†’ æ—¥å¿—
```

**è°ƒè¯•é…ç½®**:
```yaml
# configuration.yaml
logger:
  default: info
  logs:
    custom_components.ha_ip_monitor: debug
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£
- [Home Assistantå¼€å‘æ–‡æ¡£](https://developers.home-assistant.io/)
- [UFWé˜²ç«å¢™æ–‡æ¡£](https://help.ubuntu.com/community/UFW)
- [Flaskæ–‡æ¡£](https://flask.palletsprojects.com/)
- [Pythonæ­£åˆ™è¡¨è¾¾å¼](https://docs.python.org/3/library/re.html)

### é¡¹ç›®æ–‡ä»¶
- `README.md` - é¡¹ç›®æ€»ä½“è¯´æ˜
- `remote_scripts/README.md` - VPSè„šæœ¬éƒ¨ç½²æ–‡æ¡£
- `.claude/PROJECT_RULES.md` - é¡¹ç›®å¼€å‘è§„èŒƒ
- `HANDOFF_2025-11-13_v0.2.md` - ä¸Šä¸€ç‰ˆæœ¬äº¤æ¥æ–‡ä»¶

---

## ğŸ’¡ ç»™ä¸‹ä¸€ä½å¼€å‘è€…çš„å»ºè®®

1. **ä¼˜å…ˆæµ‹è¯•VPS API**
   - ç¡®ä¿åœ¨çœŸå®ç¯å¢ƒä¸­æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
   - ç‰¹åˆ«æ³¨æ„æƒé™é—®é¢˜ï¼ˆauth.logè¯»å–ã€ufwæ‰§è¡Œï¼‰

2. **æ³¨æ„å¼‚æ­¥ç¼–ç¨‹**
   - coordinatorä¸­çš„æ–¹æ³•éƒ½æ˜¯async
   - è°ƒç”¨æ—¶éœ€è¦await
   - æ³¨æ„é¿å…é˜»å¡ä¸»çº¿ç¨‹

3. **å®Œå–„é”™è¯¯å¤„ç†**
   - å½“å‰é”™è¯¯å¤„ç†å·²ç»æ¯”è¾ƒå®Œå–„
   - ä½†ä»éœ€æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ

4. **æ€§èƒ½ä¼˜åŒ–**
   - å¤§å‹auth.logæ–‡ä»¶è§£æå¯èƒ½è¾ƒæ…¢
   - è€ƒè™‘åªè§£ææœ€è¿‘24å°æ—¶çš„æ—¥å¿—

5. **å®‰å…¨ç¬¬ä¸€**
   - æ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥
   - IPæ ¼å¼éªŒè¯å¿…ä¸å¯å°‘
   - UFWå‘½ä»¤æ‰§è¡Œéœ€è¦ç‰¹åˆ«å°å¿ƒ

---

**äº¤æ¥äºº**: Claude (AI Assistant)
**äº¤æ¥æ—¶é—´**: 2025-11-13 19:00
**ç‰ˆæœ¬**: v0.3.0-dev
**Git Commit**: 51967c8 (feat: VPS APIä¸šåŠ¡é€»è¾‘å®ç°å®Œæˆ)

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
